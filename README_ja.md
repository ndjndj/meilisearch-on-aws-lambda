# Meilisearch on Amanzon Lambda

Meilisearch のサーバーレス実行環境を AWS 上に構築するためのリポジトリです。  

## Abstract 

- Meilisearch の実行環境を Lambda Web Adapter を用いて AWS Lambda で動かせるようになりました。
- インデックスの保管場所に Amazon EFS を利用しました。
- Amazon EFS の読み取り量がえらいことになりました。

→ 実用はむずかしそうという結果が得られた。

## Introduction 

Meilisearch とは、Meili 社および多くの Contributor によって開発されているオープンソースの全文検索エンジンです。  
ミリ秒単位の非常に高速な検索パフォーマンスやシンプルな API のほか、豊富な機能があり、多くの支持を得ています。
また、コミュニティが活発で、アップデートが継続的に行われる点も個人的に好きなポイントです(あとアイコンがかわいい)。

FaaS のひとつである AWS Lambda と Lambda Web Adapter を用いて、全文検索エンジンである Meilisearch の実行環境の構築に成功したものの、本番環境ではいまいち使えなさそうという結論に至ったという話をします。

コンパクトに利用方法も書いておきますが、この構成はまだおすすめはできないです。  

とはいえ、私自身かなり学びがあったので供養の意味と、もしかしたらチャンスはあるのでは？という淡い期待も込めて公開します。  
アイディアや意見・アドバイスいただけると大変ありがたいです。  

## Notice

以下の AWS サービスを利用することにより、利用料金が発生することに注意してください。  
作成する Meilisearch のインデックスサイズ、インデックス作成の頻度、検索が実行された回数により、AWS に対する利用料金は変わります。

細かい利用料金に関しては、該当のページもしくは [AWS Pricing Calculator](https://calculator.aws/#/) をご覧ください。

- [Amazon EFS](https://aws.amazon.com/jp/efs/pricing/)
    - Meilisearch インデックスの保管場所として。
- [Amazon EC2](https://aws.amazon.com/jp/ec2/pricing/) (option)
    - Meilisearch インデックスを Amazon EFS に転送するため。
- [AWS DataSync](https://aws.amazon.com/jp/datasync/pricing/) (option)
    - Meilisearch インデックスを Amazon EFS に転送するため。

## Why use serverless?

全文検索エンジンを導入するためには、Meilisearch Cloud, Algolia のようなクラウドサービスを利用することや、全文検索エンジンをセルフホスティングすることが選択肢になります。
どちらにしても、いくらかのランニングコストを支払い続ける必要があります。  

全文検索の例に限らずの話ですが、全ての製品に潤沢な予算が割り当てられているとは限られず、開発者たちは、継続した開発・運用のために低コストな方法を模索しています。  
特に、個人で開発・運営されていたり、小規模な製品において、それは顕著だと思います。  

開発者たちは、よりよい製品を作りたいという目標を掲げると同時に、継続した開発・運営のために低コストな方法を模索しています。  

今回は、できるだけ低コストで全文検索エンジンを導入したいというニーズを叶えられるかもという考えから、Meilisearch のサーバーレス環境でのビルドに挑戦しました。

AWS Lambda などの Faas には多くの無料枠が提供されています。  
また、Meilisearch の軽量さならコールドスタートによる遅延を加味しても実用に耐えられるのでは仮説を立て[^1]、できるだけ低コストで全文検索エンジンを導入したいというニーズを叶えられるかもという考えから、今回の挑戦に至りました(あと面白そうだから)。  

ちなみに、以下のように、Meilisearch をサーバーレス環境で実行するアプローチに関しては過去に行ったかたがいらっしゃいます。が Lambda で行っている事例は見つからなかったです。

[Serverless search with Meilisearch and Google Cloud Run](https://blog.simonireilly.com/posts/serverless-search)

[^1]: 書き込みできないことには目をつぶります。Meilisearch の仕様として、書き込みタスクをキューにスタックした後順番に処理するのでそもそもサーバーレスでは難しそうな気がしている。 

## Usage

サーバーレス環境作成のための手順をいくつかのステップに分けると以下のようになります。
また、検索対象となるデータはローカル(非 Lambda 環境)で作成する必要があります。

1. Meilisearch 実行環境の [Dockerfile](./prod/Dockerfile) を作成します。  
2. 1 で作成した [Dockerfile](./prod/Dockerfile) に Lambda Web Adapter を適用し、build image します。
    - 環境設定の類を設定する
    - PORT を 8080 にする必要がある
3. 2 で作成した Dockerimage を Amazon ECR に push します。
4. 3 のイメージを AWS Lambda にデプロイします。
    - Lambda のメモリは 128 MB で OK(インデックスサイズによるかも)
5. AWS Lambda に Amazon EFS をマウントします。
6. 4 でマウントした EFS のアクセスポイントに data.ms をインポートします。
    - インポート方法はなんでも構いません(DataSync でも EC2 でも)
7. 関数 URL を設定するなり API Gateway にアタッチするなりします。

## Utility 

実用性を議論するポイントは永続ストレージとして利用している data.ms のとりあつかいです。  

前提として、Meilisearch では、data.ms 直下のファイルの更新を都度行っているらしく[^2]、  
Lambda では tmp 直下以外に置いたファイルを操作しようとすると Read-only file system error が発生します[^3]。  
なので更新が発生する data.ms/ を tmp 直下以外に置くことはできません。  

かといって、tmp 直下に data.ms を置いてしまうと、AWS Lambda では tmp 直下のファイルはある程度時間がたつと消えてしまうので、うまく検索を実行することができません[^4]。  

上記のような背景から、Amazon EFS の利用を決めました。  
つまり、EFS に data.ms をインポートし、Lambda にマウントすることで、data.ms の永続性を保とうとしました。  
しかし、この方法を使うことで、データセットを毎回読み込むことになったため、EFS の読み込み量が非常に多くなってしまいます。  

今回利用したデータは、約12万個のドキュメントでインデックスのサイズは140 MiB ほどです。 この場合ですと、毎回 100 MB 近くの読み込みが発生していました。  
EFS のログを確認すると、コールドスタートの度に読み込みを行っているように思えます。  

また、書き込み系の API が Meilisearch-Lambda 経由だと現実的ではなさそうなので、  EFS においている data.ms/ を Lambda 以外の方法で更新する必要があります[^5]。  

というわけで、AWS Lambda で Meilisearch 環境を作成することに成功はしましたが、  
どうしても EFS の読み取り量がかさんでしまうことで、コストの増加は避けられない結果となりました。  

当初の目的としては、Meilisearch を運用するコストを減らすことが目的だったため、  
現在の状態で使うなら EC2 にホスティングしたほうが安上がりになる可能性が高いでしょう。  

個人運営のサイトでアクセスされる時間が固まっていたり、インデックスのサイズがもう少くなかったりすればもしかしたらという感じでしょうか。 

[^2]: 多分 lock 系のファイルですが、更新のタイミングはキャッチアップできていません。ファイルの更新日ベースの判断です。  
[^3]: これは AWS Lambda の仕様で、/tmp 以外のディレクトリは書き込みの権限は与えられていない。  
[^4]: Index not found. が発生する。もしかしたら検証の余地は残っているかもしれません。そもそもデータが image に残っていないのか  
[^5]: 機能しないわけではなさそうですが、かなり不安定で、反映が遅かったり、そもそも反映しなかったり、API のレスポンスがかなり重くなったりする現象が発生しました。先述したように、書き込みタスクをキューにスタックした後順番に処理するような仕組みが一定時間で終了するサーバーレス環境とそもそも相性がよくないのかもしれません。 

## 最後に 

Meilisearch の高い検索性能がなければサーバーレスで構築しようなどとは考えもしませんでした。Meilisearch に関わる全ての Contributor に感謝します。

今回、低コストで全文検索エンジンを導入する選択肢を増やすために挑戦してみましが、なんとも言えずの結果になりました。  

しかし、やってみてダメだと分かったこととはじめからダメだと言われたことは違います。  
Meilisearch の性能を実感することができたし、Lambda Web Adapter の便利さも知れたのでやがて私の血肉になることでしょう。きっと改善の余地はあるさ。


意見や改善点を歓迎します。  
[Issue](https://github.com/ndjndj/meilisearch-on-aws-lambda) やコメントください。