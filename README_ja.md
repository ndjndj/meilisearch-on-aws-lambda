# Meilisearch on Amanzon Lambda

Meilisearch のサーバーレス実行環境を AWS 上に構築するためのリポジトリです。  

## Abstract 

- Meilisearch の実行環境を Lambda Web Adapter を用いて AWS Lambda で動かせるようになりました。
- インデックスの保管場所に Amazon EFS を利用しました。
- Amazon EFS の読み取り量がえらいことになりました。

→ 実用はむずかしそうという結果が得られた。

## Introduction 

Meilisearch とは、Meili 社および多くの Contributor によって開発されているオープンソースの全文検索エンジンです。  
ミリ秒単位の非常に高速な検索パフォーマンスやシンプルな API のほか豊富な機能が特徴で、多くの支持を得ています。  
また、コミュニティが活発なところも私の個人的に好きなポイントの一つです。

このリポジトリでは、Meilisearch のサーバーレス実行環境の構築に成功したのですが、なんとも本番環境ではいまいち使えなさそうという結論に至りました。  
とはいえ、私自身かなり学びがあったので供養の意味と、もしかしたらチャンスはあるのでは？という淡い期待も込めて公開します。  
アイディアや意見・アドバイスいただけると大変ありがたいです。  

## Notice

リポジトリはこちら

以下の AWS サービスを利用することにより、$1 未満～ の利用料金が発生することに注意してください。  
作成する Meilisearch のインデックスサイズ、インデックス作成の頻度、検索が実行された回数により、AWS に対する利用料金は変わります。

細かい利用料金に関しては、該当のページもしくは [AWS Pricing Calculator](https://calculator.aws/#/) をご覧ください。

- [Amazon EFS](https://aws.amazon.com/jp/efs/pricing/)
    - Meilisearch インデックスの保管場所として。
- [Amazon EC2](https://aws.amazon.com/jp/ec2/pricing/) (option)
    - Meilisearch インデックスを Amazon EFS に転送するため。
- [AWS DataSync](https://aws.amazon.com/jp/datasync/pricing/) (option)
    - Meilisearch インデックスを Amazon EFS に転送するため。

## Why use serverless?

全文検索エンジンを導入したいと考えたとき、  
Meilisearch Cloud, Algolia のようなクラウドサービスを導入することや、  
全文検索エンジンをセルフホスティングすることが選択肢になります。  

どちらにしても、いくらかのランニングコストを支払い続ける必要がありますが、  
全ての製品に十分な予算が割り当てられているとは限りません。  

特に、個人で開発・運営されているような製品や小規模な製品において、それは顕著だと思います。  

開発者たちは、よりよい製品を作りたいという目標を掲げると同時に、継続した開発・運営のために低コストな方法を模索しています。  

今回は、できるだけ低コストで全文検索エンジンを導入したいというニーズを叶えられるかもという考えから、Meilisearch を無料利用枠が充実しているサーバーレス環境でのビルドに挑戦しました。

## Usage

サーバーレス環境作成のための手順をいくつかのステップに分けると以下のようになります。
また、検索対象となるデータはローカル(非 Lambda 環境)で作成する必要があります。

1. Meilisearch 実行環境の [Dockerfile](./prod/Dockerfile) を作成します。  
2. 1 で作成した [Dockerfile](./prod/Dockerfile) に Lambda Web Adapter[^1] を適用し、build image します。
    - 環境設定の類を設定する
    - PORT を 8080 にする必要がある
3. 2 で作成した Dockerimage を AWS Lambda にデプロイします。
4. AWS Lambda に Amazon EFS をマウントします。
5. 4 でマウントした EFS のアクセスポイントに data.ms をインポートします。
    - インポート方法はなんでも構いません(DataSync でも EC2 でも)

[^1]: さらっと書いてますがめっちゃすごかったです、Web アプリを Lambda で実行できるようになるやつです。

## Utility 

実用性を議論するポイントの一つとして永続ストレージとして利用している Amazon EFS の存在があります。  

前提として、Meilisearch では、data.ms 直下のファイルの更新を都度行っているっぽいです。[^2]  
Lambda で Meilisearch を使う場合、data.ms を tmp 直下以外に置くと Read-only file system error が発生します[^3]。  
なので data.ms/ を tmp 直下以外に置くことはできません。  

かといって、tmp 直下に data.ms を置いてしまうと、AWS Lambda は、tmp 直下のファイルはある程度時間がたつと消えてしまうので、うまく検索を実行することができませんでした[^4]。  

上記のような背景から、今回は Amazon EFS の利用を決めました。  

しかし、EFS に data.ms をマウントする必要があるため、EFS の読み込みサイズが非常に大きくなってしまいます。  
EFS のログを確認すると、コールドスタートの度に読み込みを行っているように思えます[^5]。  

AWS Lambda で Meilisearch 環境を作成することに成功はしましたが、どうしても EFS の読み取り量がかさんでしまう結果となりました。  

当初の目的としては、Meilisearch を運用するコストを減らすことが目的だったため、現在の状態で使うなら EC2 にホスティングしたほうが安上がりになる可能性が高いでしょう。  

あと、書き込み系の API が Meilisearch-Lambda 経由だと機能しないので、EFS においている data.ms/ を Lambda 以外の方法で更新する必要があります[^6]。  

[^2]: 多分 lock 系のファイルですが、更新のタイミングはキャッチアップできていません。ファイルの更新日ベースの判断です。

[^3]: これは AWS Lambda の仕様で、/tmp 以外のディレクトリは書き込みの権限は与えられていない。

[^4]: Index not found. が発生する。もしかしたら検証の余地は残っているかもしれません。そもそもデータが image に残っていないのかも

[^5]: ここもきちんと検証したわけではないです。どちらにせよ 100Mb 近くの呼び出しが何度も起こっていることは確かです。

[^6]: 書き込みタスクをキューにスタックした後順番に処理するのでそもそも向いていないのだと思います。

## 最後に 

Meilisearch の高い検索性能がなければサーバーレスで構築しようなどとは考えもしませんでした。Meilisearch に関わる全ての Contributor に感謝します。

今回、低コストで全文検索エンジンを導入する選択肢を増やすために挑戦してみましが、なんとも言えずの結果になりました。  

しかし、やってみてダメだと分かったこととはじめからダメだと言われたことは違います。  
Meilisearch の性能を実感することができたし、Lambda Web Adapter の便利さも知れたのでやがて私の血肉になることでしょう。きっと改善の余地はあるさ。


意見や改善点を歓迎します。  
[Issue](https://github.com/ndjndj/meilisearch-on-aws-lambda) やコメントください。